name: Auto Sync Episodes

on:
  workflow_dispatch: # ÊâãÂãïÂÆüË°å„ÇíË®±ÂèØ
  schedule:
    - cron: '0 17 * * *' # ÊØéÊó•ÂçàÂâç2ÊôÇ (JST) „Å´ÂÆüË°å (UTC 17:00)

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Trigger Vercel API Sync
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
          SYNC_AUTH_TOKEN: ${{ secrets.SYNC_AUTH_TOKEN }}
        run: |
          if [ -z "$VERCEL_URL" ]; then
            echo "‚ùå VERCEL_URL is not set. Skipping Vercel API Sync."
            echo "Please set VERCEL_URL in GitHub Secrets."
            exit 1
          fi
          
          echo "üöÄ Triggering Vercel API Sync at ${VERCEL_URL}/api/sync-incremental"
          
          # curl„Ç≥„Éû„É≥„Éâ„ÅßVercel„ÅÆAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíÂëº„Å≥Âá∫„Åô
          # SYNC_AUTH_TOKEN „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„Éò„ÉÉ„ÉÄ„Éº„Å´ËøΩÂä†
          if [ -n "$SYNC_AUTH_TOKEN" ]; then
            echo "üîê Using authentication token"
            RESPONSE=$(curl -X POST \
                 -H "Authorization: Bearer $SYNC_AUTH_TOKEN" \
                 -H "Content-Type: application/json" \
                 -w "\nHTTP_STATUS:%{http_code}" \
                 -s \
                 "${VERCEL_URL}/api/sync-incremental")
          else
            echo "‚ö†Ô∏è  No authentication token set. Proceeding without authentication."
            RESPONSE=$(curl -X POST \
                 -H "Content-Type: application/json" \
                 -w "\nHTTP_STATUS:%{http_code}" \
                 -s \
                 "${VERCEL_URL}/api/sync-incremental")
          fi
          
          # HTTP„Çπ„ÉÜ„Éº„Çø„Çπ„Ç≥„Éº„Éâ„ÇíÊäΩÂá∫
          HTTP_STATUS=$(echo "$RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
          
          echo "üìä Response Status: $HTTP_STATUS"
          echo "üìÑ Response Body:"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
          
          # „Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "‚ùå Sync failed with HTTP status: $HTTP_STATUS"
            exit 1
          fi
          
          echo "‚úÖ Sync completed successfully"
