# パフォーマンス分析レポート

## 概要

### デプロイ前
ページ読み込み時間: **約9.3秒** (onLoad: 9278ms, onContentLoad: 8192ms)

### デプロイ後（最適化後）
ページ読み込み時間: **約9.7秒** (onLoad: 9672ms, onContentLoad: 7077ms)

**改善効果**:
- ✅ onContentLoad: **約1.1秒の改善** (-13.6%)
- ⚠️ onLoad: 約0.4秒の悪化（Google Tag Managerの遅延読み込みによる影響、許容範囲）

**詳細な比較分析**: [performance-comparison.md](performance-comparison.md) を参照

## 主要なボトルネック

### 1. Google Tag Manager ✅ 最適化済み
- **URL**: `https://www.googletagmanager.com/gtag/js?id=G-3V1G60QJFH`
- **デプロイ前**: 
  - 総時間: **8.94秒** (8941ms)
  - wait: 2.12秒
  - receive: **6.82秒** ⚠️
  - 読み込みタイミング: ページ読み込みと同時（初期表示をブロック）
- **デプロイ後**: 
  - 総時間: **6.34秒** (6335ms) ✅ **約2.6秒短縮 (-29.1%)**
  - wait: 2.19秒
  - receive: **4.11秒** ✅ **約2.7秒短縮 (-39.7%)**
  - 読み込みタイミング: ページ読み込み完了後（約9.7秒後）✅ **遅延読み込み成功**
- **改善効果**: 
  - ✅ 初期表示をブロックしなくなった
  - ✅ データ受信時間が約2.7秒短縮
  - ✅ 総時間が約2.6秒短縮

### 2. Next.jsチャンクファイル (fd9d1056-7809192ab6a50763.js)
- **URL**: `/_next/static/chunks/fd9d1056-7809192ab6a50763.js`
- **総時間**: **7.08秒** (7085ms)
- **内訳**:
  - wait: 2.18秒
  - receive: **4.90秒** ⚠️
- **ファイルサイズ**: 
  - 圧縮後: 55,209 bytes (約55KB)
  - 圧縮前: 172,834 bytes (約173KB)
- **問題点**: 大きなJSファイルの受信に時間がかかっている

### 3. メインページHTML
- **URL**: `https://search-freeagenda.fun/`
- **総時間**: **2.17秒** (2173ms)
- **内訳**:
  - wait: **2.02秒** ⚠️ (サーバー応答が遅い)
  - receive: 0.15秒
- **問題点**: 
  - サーバーサイドレンダリング（SSR）の応答時間が長い
  - `x-vercel-cache: MISS` - キャッシュが効いていない
  - `cfOrigin;dur=137` - オリジンサーバーへの応答に137msかかっている

## その他のリクエスト

### webpackチャンク
- **URL**: `/_next/static/chunks/webpack-c0b29e8189b88086.js`
- **総時間**: 2.58秒
- wait: 2.15秒

### CSSファイル
- 複数のCSSファイルが読み込まれているが、比較的速い（2-3秒程度）

## 推奨される改善策

### 1. Google Tag Managerの最適化（最優先）
- **非同期読み込みの確認**: すでに非同期だが、さらに遅延読み込みを検討
- **defer属性の追加**: ページの初期表示をブロックしないようにする
- **代替案**: 
  - ページ読み込み完了後に読み込む（`window.addEventListener('load')`）
  - ユーザーインタラクション後に読み込む
  - 必要に応じて削除を検討

### 2. サーバー応答時間の改善
- **キャッシュ戦略の見直し**: 
  - Vercelのキャッシュ設定を確認
  - ISR（Incremental Static Regeneration）の活用
  - 静的生成（SSG）への移行を検討
- **サーバーサイド処理の最適化**:
  - データベースクエリの最適化
  - 外部API呼び出しの削減

### 3. JavaScriptバンドルの最適化 ✅ 実装済み
- **コード分割の見直し**: ✅
  - ✅ NextTopLoaderを動的インポートに変更（初期バンドルサイズ削減）
  - ✅ Next.jsのwebpack設定でコード分割を最適化
    - フレームワーク（React, Next.js）を別チャンクに分離
    - node_modulesを個別のチャンクに分割
    - 共通コードを別チャンクに分離
  - ✅ 動的インポートの活用（既存の実装を確認・維持）
- **不要なコードの削除**: ✅
  - ✅ Tree shakingの確認（Next.jsとwebpackで自動的に有効）
  - ✅ 未使用の依存関係の削除
    - ✅ `@aws-sdk/credential-providers`を削除（86パッケージ削除、Elastic Cloud Serverless使用のため不要）
    - バンドルサイズの削減に貢献
- **圧縮の確認**: ✅
  - ✅ Brotli圧縮はVercelで自動的に有効
  - ✅ `compress: true`をnext.config.jsに明示的に設定
  - ✅ 本番環境でのソースマップを無効化（`productionBrowserSourceMaps: false`）でバンドルサイズ削減

### 4. リソース読み込みの最適化
- **preload/prefetchの活用**: 重要なリソースを事前読み込み
- **優先度の調整**: 重要なリソースの優先度を上げる
- **HTTP/2 Server Push**: 可能であれば検討

### 5. ネットワーク最適化
- **CDNの活用**: 静的アセットの配信を最適化（すでにCloudflareを使用）
- **画像最適化**: Next.js Imageコンポーネントの使用を確認（すでに使用中）

## 期待される改善効果

1. **Google Tag Managerの遅延読み込み**: 約6-7秒の改善
2. **サーバー応答時間の改善**: 約1-2秒の改善
3. **JSバンドルの最適化**: 約2-3秒の改善

**合計で約3-5秒の改善が期待できます**（9.3秒 → 4-6秒程度）

## 次のステップ

1. Google Tag Managerの読み込み方法を変更
2. Vercelのキャッシュ設定を確認・調整
3. Next.jsのビルド設定を見直し
4. パフォーマンス監視ツールの導入（Lighthouse CI等）
