name: Auto Sync Episodes

on:
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    # UTCæ™‚é–“ã§è¨­å®šï¼ˆJST = UTC+9 ãªã®ã§ã€UTC 17:00 = JST 02:00ï¼‰
    - cron: '0 17 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  sync:
    name: Sync New Episodes
    runs-on: ubuntu-latest
    timeout-minutes: 10 # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’10åˆ†ã«è¨­å®š

    steps:
      - name: Sync Episodes
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
          SYNC_AUTH_TOKEN: ${{ secrets.SYNC_AUTH_TOKEN }}
        run: |
          echo "ğŸ”„ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®å·®åˆ†åŒæœŸã‚’é–‹å§‹ã—ã¾ã™..."
          echo "ğŸ“ Vercel URL: ${VERCEL_URL}"
          
          # èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®æº–å‚™ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
          if [ -n "$SYNC_AUTH_TOKEN" ]; then
            AUTH_HEADER="-H \"Authorization: Bearer ${SYNC_AUTH_TOKEN}\""
            echo "ğŸ” èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          else
            AUTH_HEADER=""
            echo "âš ï¸  èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯æ¨å¥¨ï¼‰"
          fi
          
          # Vercelã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™
          HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" -X POST \
            $AUTH_HEADER \
            -H "Content-Type: application/json" \
            "${VERCEL_URL}/api/sync-incremental")
          
          echo "ğŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${HTTP_CODE}"
          echo "ğŸ“„ ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
          cat /tmp/response.json
          echo ""
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… åŒæœŸãŒæˆåŠŸã—ã¾ã—ãŸ"
            
            # æ–°è¦ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ã‚’å–å¾—ï¼ˆjqãŒä½¿ãˆãªã„å ´åˆã«å‚™ãˆã¦grepã‚’ä½¿ç”¨ï¼‰
            if command -v jq &> /dev/null; then
              NEW_EPISODES=$(cat /tmp/response.json | jq -r '.newEpisodes // 0')
              SYNCED_EPISODES=$(cat /tmp/response.json | jq -r '.syncedEpisodes // 0')
              SYNCED_TRANSCRIPTS=$(cat /tmp/response.json | jq -r '.syncedTranscripts // 0')
            else
              # jqãŒä½¿ãˆãªã„å ´åˆã¯grepã§æŠ½å‡º
              NEW_EPISODES=$(cat /tmp/response.json | grep -o '"newEpisodes":[0-9]*' | grep -o '[0-9]*' || echo "0")
              SYNCED_EPISODES=$(cat /tmp/response.json | grep -o '"syncedEpisodes":[0-9]*' | grep -o '[0-9]*' || echo "0")
              SYNCED_TRANSCRIPTS=$(cat /tmp/response.json | grep -o '"syncedTranscripts":[0-9]*' | grep -o '[0-9]*' || echo "0")
            fi
            
            if [ "$NEW_EPISODES" -gt 0 ]; then
              echo "ğŸ“ æ–°è¦ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰: ${NEW_EPISODES}ä»¶"
              echo "ğŸ’¾ åŒæœŸæ¸ˆã¿ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰: ${SYNCED_EPISODES}ä»¶"
              echo "ğŸ“„ åŒæœŸæ¸ˆã¿æ–‡å­—èµ·ã“ã—: ${SYNCED_TRANSCRIPTS}ä»¶"
            else
              echo "â„¹ï¸  æ–°è¦ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            fi
          else
            echo "âŒ åŒæœŸãŒå¤±æ•—ã—ã¾ã—ãŸ (HTTP ${HTTP_CODE})"
            echo "ã‚¨ãƒ©ãƒ¼å†…å®¹:"
            cat /tmp/response.json
            exit 1
          fi
